window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)};var Verlet3D=function(t){this.canvas=t.canvas,this.ctx=canvas.getContext("2d"),this.draggedParticle=-1,this.draggedModel=0,this.mouse={down:!1,x:0,y:0,ox:0,oy:0,button:0,clicked:0},this.ctx.lineWidth=t.lineWidth||.7,this.ctx.fillStyle=t.fillStyle||"#00D5B4",this.ctx.strokeStyle=t.strokeStyle||"#666";var e=this;this.canvas.onmousemove=function(t){var s=e.canvas.getBoundingClientRect();e.mouse.ox=e.mouse.x,e.mouse.oy=e.mouse.y,e.mouse.x=t.clientX-s.left,e.mouse.y=t.clientY-s.top,t.preventDefault()},this.canvas.onmousedown=function(t){e.mouse.button=t.which,e.mouse.down=!0,t.preventDefault()},this.canvas.onmouseup=function(t){e.mouse.down=!1,e.draggedParticle=-1,t.preventDefault()},this.canvas.oncontextmenu=function(t){t.preventDefault()}};Verlet3D.prototype.rotateCamera=function(t){t.model.angleY+=t.y||0,t.model.angleX+=t.x||0,t.model.angleZ+=t.z||0},Verlet3D.prototype.calc3D=function(t){t.vertex=[];for(var e=0;e<t.particles.length;e++)t.vertex.push({x:t.particles[e].x,y:t.particles[e].y,z:t.particles[e].z});for(var e=0;e<t.vertex.length;e++){var s=t.vertex[e],i=s.x*t.scale,o=s.y*t.scale,a=s.z*t.scale,r=Math.cos(t.angleX),n=Math.sin(t.angleX),l=Math.cos(t.angleY),c=Math.sin(t.angleY),h=Math.cos(t.angleZ),d=Math.sin(t.angleZ),x=r*o-n*a,f=n*o+r*a,v=l*f-c*i,u=c*f+l*i,p=h*u-d*x,y=d*u+h*x;s.x=p,s.y=y,s.z=v}},Verlet3D.prototype.calcVerlet=function(t){for(var e=0;e<t.particles.length;e++){var s=t.particles[e],i=s.x-s.ox,o=s.y-s.oy,a=s.z-s.oz;0===s.lock?(s.ox=s.x,s.oy=s.y,s.oz=s.z,s.x=s.x+i*t.friction,s.y=s.y+o+t.gravity,s.z=s.z+a*t.friction):(s.x=s.ox,s.y=s.oy,s.z=s.oz)}for(var e=0;e<t.iterations;e++)for(var r=0;r<t.constraints.length;r++){var n=t.particles[t.constraints[r].f],l=t.particles[t.constraints[r].s],c=n.x-l.x,h=n.y-l.y,d=n.z-l.z,x=Math.sqrt(c*c+h*h+d*d),f=(t.constraints[r].dist-x)/x,i=.5*c,o=.5*h,a=.5*d;n.x=n.x+i*f,n.y=n.y+o*f,n.z=n.z+a*f,l.x=l.x-i*f,l.y=l.y-o*f,l.z=l.z-a*f,x>t.tear_distance&&t.constraints.splice(r,1)}};var Model=function(t){this.vertex=[],this.particles=[],this.constraints=[],this.xPos=t.xPos||0,this.yPos=t.yPos||0,this.angleX=0,this.angleY=0,this.angleZ=0,this.scale=t.scale||1,this.gravity=t.gravity||.2,this.friction=t.friction||.99,this.iterations=t.iterations||5,this.tear_distance=t.tearDistance||120,this.field_of_view=t.fov||1500};Model.prototype.createParticle=function(t,e,s,i){this.particles.push({x:t,y:e,z:s,ox:t,oy:e,oz:s,lock:i||0})},Model.prototype.createConstraint=function(t,e){this.constraints.push({f:t,s:e,dist:Math.sqrt(Math.pow(this.particles[t].x-this.particles[e].x,2)+Math.pow(this.particles[t].y-this.particles[e].y,2)+Math.pow(this.particles[t].z-this.particles[e].z,2))})},Model.prototype.createConstraintsBasedOnDistance=function(t){for(var e=0;e<this.particles.length;e++)for(var s=e+1;s<this.particles.length;s++){var i=Math.sqrt(Math.pow(this.particles[e].x-this.particles[s].x,2)+Math.pow(this.particles[e].y-this.particles[s].y,2)+Math.pow(this.particles[e].z-this.particles[s].z,2));t>i&&this.createConstraint(e,s)}},Verlet3D.prototype.draw3D=function(t){if(t.constructor!==Array)var t=[t];this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.beginPath();for(var e=0;e<t.length;e++)for(var s=t[e],i=0;i<s.constraints.length;i++)for(var o=0;2>o;o++){var a=1==o?s.vertex[s.constraints[i].f]:s.vertex[s.constraints[i].s],r=s.field_of_view/(s.field_of_view+a.z),n=a.x*r+s.xPos,l=a.y*r+s.yPos;0===o?this.ctx.moveTo(n,l):this.ctx.lineTo(n,l)}this.ctx.closePath(),this.ctx.stroke()},Verlet3D.prototype.findClosest=function(t){if(t.constructor!==Array)var t=[t];this.smallest=1e6,this.highestZ=-1e6;for(var e=0;e<t.length;e++)for(var s=t[e],i=0;i<t[e].vertex.length;i++){var o=s.vertex[i],a=s.field_of_view/(s.field_of_view+o.z),r=o.x*a+s.xPos,n=o.y*a+s.yPos,l=Math.sqrt(Math.pow(r-this.mouse.x,2)+Math.pow(n-this.mouse.y,2));l<this.smallest&&10>l&&o.z>this.highestZ&&(this.highestZ=o.z,this.smallest=l,this.smallestparticle=i,this.model=e)}return void 0==this.smallestparticle?0:{particle:this.smallestparticle,model:this.model}},Verlet3D.prototype.handleMouse=function(t){if(t.constructor!==Array)var t=[t];if(this.mouse.down===!0){if(this.mouse.clicked=1,-1==this.draggedParticle){var e=this.findClosest(t);if(0===e)return;var s=t[e.model],i=t[e.model].vertex[e.particle]}else var s=t[this.draggedModel],i=t[this.draggedModel].vertex[this.draggedParticle];var o=s.field_of_view/(s.field_of_view+i.z),a=i.x*o+s.xPos,r=i.y*o+s.yPos;if(this.ctx.beginPath(),this.ctx.arc(a,r,5,5,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill(),1==this.mouse.button&&(-1==this.draggedParticle&&(this.draggedParticle=e.particle,this.draggedModel=e.model),s.particles[this.draggedParticle].x+=25*(this.mouse.x-this.mouse.ox),s.particles[this.draggedParticle].y+=25*(this.mouse.y-this.mouse.oy)),3==this.mouse.button)for(var n=0;n<s.constraints.length;n++)(s.constraints[n].f==e.particle||s.constraints[n].s==e.particle)&&s.constraints.splice(n,1);2==this.mouse.button&&(s.angleX+=(this.mouse.y-this.mouse.oy)/25,s.angleY+=(this.mouse.x-this.mouse.ox)/25)}else{var e=this.findClosest(t);if(0===e)return;var s=t[e.model],i=t[e.model].vertex[e.particle],o=s.field_of_view/(s.field_of_view+i.z),a=i.x*o+s.xPos,r=i.y*o+s.yPos;this.ctx.beginPath(),this.ctx.arc(a,r,5,5,0,2*Math.PI),this.ctx.closePath(),this.ctx.stroke()}};