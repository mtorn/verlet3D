function Verlet3D(t){this.canvas=t.canvas,this.ctx=canvas.getContext("2d"),this.draggedParticle=-1,this.draggedModel=0,this.mouse={down:!1,x:0,y:0,ox:0,oy:0,button:0,clicked:0},this.ctx.lineWidth=t.lineWidth||.7,this.ctx.fillStyle=t.fillStyle||"#00D5B4",this.ctx.strokeStyle=t.strokeStyle||"#666";var e=this;this.canvas.onmousemove=function(t){var a=e.canvas.getBoundingClientRect();e.mouse.ox=e.mouse.x,e.mouse.oy=e.mouse.y,e.mouse.x=t.clientX-a.left,e.mouse.y=t.clientY-a.top,t.preventDefault()},this.canvas.onmousedown=function(t){e.mouse.button=t.which,e.mouse.down=!0,t.preventDefault()},this.canvas.onmouseup=function(t){e.mouse.down=!1,e.draggedParticle=-1,t.preventDefault()},this.canvas.oncontextmenu=function(t){t.preventDefault()}}window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)},Verlet3D.prototype.rotateCamera=function(t){t.model.angleY+=t.y||0,t.model.angleX+=t.x||0,t.model.angleZ+=t.z||0},Verlet3D.prototype.calc3D=function(t){for(t.vertex=[],i=0;i<t.particles.length;i++)t.vertex.push({x:t.particles[i].x,y:t.particles[i].y,z:t.particles[i].z});for(i=0;i<t.vertex.length;i++)data=t.vertex[i],x=data.x*t.scale,y=data.y*t.scale,z=data.z*t.scale,xcosa=Math.cos(t.angleX),xsina=Math.sin(t.angleX),ycosa=Math.cos(t.angleY),ysina=Math.sin(t.angleY),zcosa=Math.cos(t.angleZ),zsina=Math.sin(t.angleZ),xy=xcosa*y-xsina*z,xz=xsina*y+xcosa*z,yz=ycosa*xz-ysina*x,yx=ysina*xz+ycosa*x,zx=zcosa*yx-zsina*xy,zy=zsina*yx+zcosa*xy,data.x=zx,data.y=zy,data.z=yz},Verlet3D.prototype.calcVerlet=function(t){for(i=0;i<t.particles.length;i++)data=t.particles[i],dx=data.x-data.ox,dy=data.y-data.oy,dz=data.z-data.oz,0==data.lock?(data.ox=data.x,data.oy=data.y,data.oz=data.z,data.x=data.x+dx*t.friction,data.y=data.y+dy+t.gravity,data.z=data.z+dz*t.friction):(data.x=data.ox,data.y=data.oy,data.z=data.oz);for(i=0;i<t.iterations;i++)for(c=0;c<t.constraints.length;c++)c1=t.particles[t.constraints[c].f],c2=t.particles[t.constraints[c].s],diffx=c1.x-c2.x,diffy=c1.y-c2.y,diffz=c1.z-c2.z,dist=Math.sqrt(diffx*diffx+diffy*diffy+diffz*diffz),diff=(t.constraints[c].dist-dist)/dist,dx=.5*diffx,dy=.5*diffy,dz=.5*diffz,c1.x=c1.x+dx*diff,c1.y=c1.y+dy*diff,c1.z=c1.z+dz*diff,c2.x=c2.x-dx*diff,c2.y=c2.y-dy*diff,c2.z=c2.z-dz*diff,dist>t.tear_distance&&t.constraints.splice(c,1)};var Model=function(t){this.vertex=[],this.particles=[],this.constraints=[],this.xPos=t.xPos||0,this.yPos=t.yPos||0,this.angleX=0,this.angleY=0,this.angleZ=0,this.scale=t.scale||1,this.gravity=t.gravity||.2,this.friction=t.friction||.99,this.iterations=t.iterations||5,this.tear_distance=t.tearDistance||120,this.field_of_view=t.fov||1500,this.zMax=0};Model.prototype.createParticle=function(t,e,a,i){this.particles.push({x:t,y:e,z:a,ox:t,oy:e,oz:a,lock:i||0})},Model.prototype.createConstraint=function(t,e){this.constraints.push({f:t,s:e,dist:Math.sqrt(Math.pow(this.particles[t].x-this.particles[e].x,2)+Math.pow(this.particles[t].y-this.particles[e].y,2)+Math.pow(this.particles[t].z-this.particles[e].z,2))})},Model.prototype.createConstraintsBasedOnDistance=function(t){for(i=0;i<this.particles.length;i++)for(c=i+1;c<this.particles.length;c++)dist=Math.sqrt(Math.pow(this.particles[i].x-this.particles[c].x,2)+Math.pow(this.particles[i].y-this.particles[c].y,2)+Math.pow(this.particles[i].z-this.particles[c].z,2)),dist<t&&this.createConstraint(i,c)},Verlet3D.prototype.draw3D=function(t){for(t.constructor!==Array&&(t=[t]),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.beginPath(),modeln=0;modeln<t.length;modeln++)for(model=t[modeln],i=0;i<model.constraints.length;i++)for(c=0;c<2;c++)data=1==c?model.vertex[model.constraints[i].f]:model.vertex[model.constraints[i].s],fov=model.field_of_view/(model.field_of_view+data.z),x=data.x*fov+model.xPos,y=data.y*fov+model.yPos,0==c?this.ctx.moveTo(x,y):this.ctx.lineTo(x,y);this.ctx.closePath(),this.ctx.stroke()},Verlet3D.prototype.findClosest=function(t){for(t.constructor!==Array&&(t=[t]),this.smallest=1e6,this.highestZ=-1e6,modeln=0;modeln<t.length;modeln++)for(modeldata=t[modeln],modeldata.zMax=0,i=0;i<model.vertex.length;i++)data=modeldata.vertex[i],fov=modeldata.field_of_view/(modeldata.field_of_view+data.z),x=data.x*fov+modeldata.xPos,y=data.y*fov+modeldata.yPos,dist=Math.sqrt(Math.pow(x-this.mouse.x,2)+Math.pow(y-this.mouse.y,2)),dist<this.smallest&&dist<10&&data.z>this.highestZ&&(this.highestZ=data.z,this.smallest=dist,this.smallestparticle=i,this.model=modeln);return void 0==this.smallestparticle?0:{particle:this.smallestparticle,model:this.model}},Verlet3D.prototype.handleMouse=function(t){if(t.constructor!==Array&&(t=[t]),1==this.mouse.down){if(this.mouse.clicked=1,-1==this.draggedParticle){if(data=this.findClosest(t),0==data)return;model=t[data.model],pdata=t[data.model].vertex[data.particle]}else model=t[this.draggedModel],pdata=t[this.draggedModel].vertex[this.draggedParticle];if(fov=model.field_of_view/(model.field_of_view+pdata.z),x=pdata.x*fov+model.xPos,y=pdata.y*fov+model.yPos,this.ctx.beginPath(),this.ctx.arc(x,y,5,5,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill(),1==this.mouse.button&&(-1==this.draggedParticle&&(this.draggedParticle=data.particle,this.draggedModel=data.model),model.particles[this.draggedParticle].x+=25*(this.mouse.x-this.mouse.ox),model.particles[this.draggedParticle].y+=25*(this.mouse.y-this.mouse.oy)),3==this.mouse.button)for(c=0;c<model.constraints.length;c++)(model.constraints[c].f==data.particle||model.constraints[c].s==data.particle)&&model.constraints.splice(c,1);2==this.mouse.button&&(model.angleX+=(this.mouse.y-this.mouse.oy)/25,model.angleY+=(this.mouse.x-this.mouse.ox)/25)}else{if(data=this.findClosest(t),0==data)return;model=t[data.model],pdata=t[data.model].vertex[data.particle],fov=model.field_of_view/(model.field_of_view+pdata.z),x=pdata.x*fov+model.xPos,y=pdata.y*fov+model.yPos,this.ctx.beginPath(),this.ctx.arc(x,y,5,5,0,2*Math.PI),this.ctx.closePath(),this.ctx.stroke()}};